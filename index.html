<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Turbo Converter ‚ö° ULTRA HD Inteligente</title>
<style>
  body {
    background-color: #121212;
    color: #fff;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
  }
  .box {
    background: #1e1e1e;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    width: 90%;
    max-width: 440px;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 8px;
    border: none;
    outline: none;
    font-size: 15px;
  }
  input[type="file"], input[type="text"] {
    background: #2a2a2a;
    color: #ccc;
  }
  button {
    background: #00b4d8;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover { background: #0096c7; }
  #progressContainer {
    width: 100%;
    background: #333;
    border-radius: 8px;
    margin-top: 10px;
    height: 20px;
    display: none;
  }
  #progressBar {
    height: 100%;
    width: 0%;
    background: #00b4d8;
    border-radius: 8px;
    transition: width 0.1s linear;
  }
  #status {
    text-align: center;
    margin-top: 8px;
    font-size: 14px;
    color: #aaa;
  }
</style>
</head>
<body>

<div class="box">
  <h2>PDF Turbo Converter ‚ö° ULTRA HD</h2>
  <input type="file" id="imagenes" multiple accept="image/*" />
  <input type="text" id="nombrePDF" placeholder="Nombre del PDF (sin .pdf)" />
  <button id="crearPDF">Generar PDF</button>
  <div id="progressContainer"><div id="progressBar"></div></div>
  <div id="status"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

document.getElementById("crearPDF").addEventListener("click", async () => {
  const archivos = Array.from(document.getElementById("imagenes").files);
  if (!archivos.length) return alert("Selecciona im√°genes primero.");

  const nombre = (document.getElementById("nombrePDF").value || "imagenes") + ".pdf";

  const pdf = new jsPDF({
    unit: "pt",
    format: "a4",
    orientation: "portrait",
    compress: true
  });

  const progressBar = document.getElementById("progressBar");
  const progressContainer = document.getElementById("progressContainer");
  const status = document.getElementById("status");
  progressContainer.style.display = "block";

  status.textContent = "Cargando im√°genes...";
  const dataURLs = await Promise.all(archivos.map(a => fileToSmartDataURL(a)));

  let total = dataURLs.length;
  let done = 0;

  for (const dataURL of dataURLs) {
    const img = await loadImage(dataURL);
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    if (done > 0) pdf.addPage();

    // Fondo blanco
    pdf.setFillColor(255, 255, 255);
    pdf.rect(0, 0, pageWidth, pageHeight, "F");

    // Ajuste proporcional para llenar la p√°gina
    const scale = Math.max(pageWidth / img.width, pageHeight / img.height);
    const w = img.width * scale;
    const h = img.height * scale;
    const x = Math.floor((pageWidth - w) / 2);
    const y = Math.floor((pageHeight - h) / 2);

    pdf.addImage(dataURL, "JPEG", x, y, w, h, undefined, "FAST");

    done++;
    progressBar.style.width = ((done / total) * 100) + "%";
    status.textContent = `Procesando ${done}/${total}`;
  }

  status.textContent = "Guardando PDF...";
  pdf.save(nombre);
  status.textContent = "‚úÖ PDF generado (Modo Inteligente)";
  setTimeout(() => {
    progressContainer.style.display = "none";
    progressBar.style.width = "0%";
  }, 1500);
});

async function fileToSmartDataURL(file) {
  const dataURL = await fileToBase64(file);
  const img = await loadImage(dataURL);

  // üß† Detecci√≥n inteligente de nivel de detalle
  const complexity = await analyzeImageDetail(img);

  // Si hay muchos bordes (texto o l√≠neas finas): usa modo HD
  const isTextual = complexity > 0.10;

  const MAX = isTextual ? 4000 : 3200;
  const QUALITY = isTextual ? 0.95 : 0.85;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  let w = img.width, h = img.height;
  if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
  else if (h > MAX) { w *= MAX / h; h = MAX; }

  canvas.width = w;
  canvas.height = h;

  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = isTextual ? "medium" : "high";
  ctx.drawImage(img, 0, 0, w, h);

  return canvas.toDataURL("image/jpeg", QUALITY);
}

// üîç Analiza cantidad de bordes para detectar texto o detalles
async function analyzeImageDetail(img) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const size = 200;
  canvas.width = size;
  canvas.height = size;
  ctx.drawImage(img, 0, 0, size, size);
  const data = ctx.getImageData(0, 0, size, size).data;
  let diffCount = 0, total = 0;

  for (let i = 0; i < data.length - 4; i += 4) {
    const lum1 = 0.3 * data[i] + 0.59 * data[i+1] + 0.11 * data[i+2];
    const lum2 = 0.3 * data[i+4] + 0.59 * data[i+5] + 0.11 * data[i+6];
    if (Math.abs(lum1 - lum2) > 30) diffCount++;
    total++;
  }

  return diffCount / total; // proporci√≥n de cambios bruscos = detalle
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function loadImage(src) {
  return new Promise((res, rej) => {
    const img = new Image();
    img.onload = () => res(img);
    img.onerror = rej;
    img.src = src;
  });
}
</script>

</body>
</html>
